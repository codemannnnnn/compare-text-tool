<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Text Compare Tool</title>
  <style>
    :root {
      --bg-main: #121212;
      --bg-panel: #1e1e1e;
      --bg-panel-alt: #2a2a2a;
      --accent: #3a82f7;
      --accent-light: #4c8dff;
      --text-main: #e0e0e0;
      --text-muted: #aaaaaa;
      --border: #333333;
      /* highlight colors */
      --deleted: #ff4c4c;
      --inserted: #2ecc71;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    #header {
      padding: 10px 16px;
      background: #181818;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #header-title {
      font-size: 18px;
      font-weight: 600;
      margin-right: 16px;
    }

    button {
      border: 1px solid var(--border);
      background: var(--bg-panel-alt);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #3a3a3a;
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }

    button.primary:hover {
      background: var(--accent-light);
    }

    /* Status bar */
    #status-bar {
      padding: 6px 16px;
      background: #161616;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-muted);
    }

    #status-message.status-ok {
      color: #2ecc71;
    }

    #status-message.status-diff {
      color: #f1c40f;
    }

    /* Tabs */
    #tab-bar {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      background: #181818;
      gap: 4px;
    }

    .tab-btn {
      padding: 4px 10px;
      font-size: 13px;
      background: var(--bg-panel-alt);
      border-radius: 4px 4px 0 0;
      border: 1px solid var(--border);
      border-bottom: none;
      cursor: pointer;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn.active {
      background: var(--bg-panel);
      color: #ffffff;
      border-bottom: 1px solid var(--bg-panel);
    }

    .tab-title {
      white-space: nowrap;
    }

    .tab-close {
      font-weight: 700;
      font-size: 14px;
      color: #888888;
      padding: 0 2px;
      cursor: pointer;
    }

    .tab-close:hover {
      color: #ff6b6b;
    }

    #add-tab-btn {
      margin-left: auto;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Tab content */
    #tab-content {
      flex: 1;
      position: relative;
      background: var(--bg-panel);
      overflow: hidden;
    }

    .tab-panel {
      position: absolute;
      inset: 0;
      display: none;
      padding: 10px;
      gap: 10px;
      background: var(--bg-panel);
    }

    .tab-panel.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr;
      column-gap: 10px;
      row-gap: 6px;
    }

    .editor-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .editor-container {
      position: relative;
      border: 1px solid var(--border);
      background: #161616;
      border-radius: 4px;
      overflow: hidden;
    }

    .editor {
      height: 100%;
      width: 100%;
      padding: 8px;
      outline: none;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-family: "JetBrains Mono", "Consolas", monospace;
      font-size: 13px;
      line-height: 1.4;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .editor[contenteditable="true"]:empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
      pointer-events: none;
    }

    .deleted {
      background: var(--deleted);
      color: #000;
      font-weight: 500;
    }

    .inserted {
      background: var(--inserted);
      color: #000;
      font-weight: 500;
    }

    /* Scrollbars*/
    .editor::-webkit-scrollbar {
      width: 8px;
    }
    .editor::-webkit-scrollbar-track {
      background: #161616;
    }
    .editor::-webkit-scrollbar-thumb {
      background: #333333;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="app">
  <div id="header">
    <div id="header-title">Text Compare Tool</div>
    <button id="compare-btn" class="primary">Compare</button>
    <button id="clear-btn">Clear</button>
  </div>

  <div id="status-bar">
    <span id="status-message">Ready to compare.</span>
  </div>

  <div id="tab-bar">
    <button id="add-tab-btn" title="Add new tab">+</button>
  </div>

  <div id="tab-content">
  </div>
</div>

<script>
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\n/g, "<br>");
  }

  function diffChars(a, b) {
    const n = a.length;
    const m = b.length;

    const dp = Array(n + 1);
    for (let i = 0; i <= n; i++) {
      dp[i] = new Array(m + 1).fill(0);
    }

    for (let i = 1; i <= n; i++) {
      for (let j = 1; j <= m; j++) {
        if (a[i - 1] === b[j - 1]) {
          dp[i][j] = dp[i - 1][j - 1] + 1;
        } else {
          dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
        }
      }
    }

    // Reconstruct diff ops from dp (backwards)
    const ops = [];
    let i = n, j = m;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && a[i - 1] === b[j - 1]) {
        ops.push({ type: "equal", char: a[i - 1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
        ops.push({ type: "insert", char: b[j - 1] });
        j--;
      } else if (i > 0 && (j === 0 || dp[i][j - 1] < dp[i - 1][j])) {
        ops.push({ type: "delete", char: a[i - 1] });
        i--;
      }
    }
    ops.reverse();

    // Group consecutive ops of same type into "chunks"
    const grouped = [];
    for (const op of ops) {
      const last = grouped[grouped.length - 1];
      if (last && last.type === op.type) {
        last.text += op.char;
      } else {
        grouped.push({ type: op.type, text: op.char });
      }
    }

    return grouped;
  }

  function applyDiffToEditors(leftEditor, rightEditor) {
    // Get plain text (no spans) from editors
    const leftText = leftEditor.innerText.replace(/\r/g, "");
    const rightText = rightEditor.innerText.replace(/\r/g, "");

    const diffOps = diffChars(leftText, rightText);

    let leftHtml = "";
    let rightHtml = "";
    let hasDiff = false;

    for (const op of diffOps) {
      if (op.type === "equal") {
        const esc = escapeHtml(op.text);
        leftHtml += esc;
        rightHtml += esc;
      } else if (op.type === "delete") {
        hasDiff = true;
        const esc = escapeHtml(op.text);
        leftHtml += `<span class="deleted">${esc}</span>`;
      } else if (op.type === "insert") {
        hasDiff = true;
        const esc = escapeHtml(op.text);
        rightHtml += `<span class="inserted">${esc}</span>`;
      }
    }

    // Replace content with highlighted HTML
    leftEditor.innerHTML = leftHtml || "&nbsp;";
    rightEditor.innerHTML = rightHtml || "&nbsp;";

    return hasDiff;
  }

  function clearFormatting(editor) {
    // Strip spans / HTML and keep plain text
    const plain = editor.innerText.replace(/\r/g, "");
    editor.textContent = plain || "";
  }

  // --- Tab management ---
  const tabBar = document.getElementById("tab-bar");
  const tabContent = document.getElementById("tab-content");
  const addTabBtn = document.getElementById("add-tab-btn");
  const compareBtn = document.getElementById("compare-btn");
  const clearBtn = document.getElementById("clear-btn");
  const statusMessage = document.getElementById("status-message");

  let tabs = [];
  let activeTabId = null;
  let tabCounter = 0;

  function createTab() {
    tabCounter++;
    const id = "tab-" + tabCounter;

    // Create tab button
    const tabBtn = document.createElement("button");
    tabBtn.className = "tab-btn";
    tabBtn.dataset.tabId = id;
    tabBtn.innerHTML = `
      <span class="tab-title">Compare ${tabCounter}</span>
      <span class="tab-close" title="Close tab">&times;</span>
    `;

    // Insert before the "+ tab" button
    tabBar.insertBefore(tabBtn, addTabBtn);

    // Create panel
    const panel = document.createElement("div");
    panel.className = "tab-panel";
    panel.dataset.tabId = id;

    // Labels
    const leftLabel = document.createElement("div");
    leftLabel.className = "editor-label";
    leftLabel.textContent = "Left Text";

    const rightLabel = document.createElement("div");
    rightLabel.className = "editor-label";
    rightLabel.textContent = "Right Text";

    // Left editor
    const leftContainer = document.createElement("div");
    leftContainer.className = "editor-container";

    const leftEditor = document.createElement("div");
    leftEditor.className = "editor";
    leftEditor.contentEditable = "true";
    leftEditor.dataset.placeholder = "Type or paste text here...";
    leftContainer.appendChild(leftEditor);

    const rightContainer = document.createElement("div");
    rightContainer.className = "editor-container";

    const rightEditor = document.createElement("div");
    rightEditor.className = "editor";
    rightEditor.contentEditable = "true";
    rightEditor.dataset.placeholder = "Type or paste text here...";
    rightContainer.appendChild(rightEditor);

    panel.appendChild(leftLabel);
    panel.appendChild(rightLabel);
    panel.appendChild(leftContainer);
    panel.appendChild(rightContainer);

    tabContent.appendChild(panel);

    const tabObj = { id, tabBtn, panel, leftEditor, rightEditor };
    tabs.push(tabObj);

    // Tab click = activate
    tabBtn.addEventListener("click", (e) => {
      // Ignore if clicking close icon (handled separately)
      if (e.target.classList.contains("tab-close")) return;
      setActiveTab(id);
    });

    // Close icon
    const closeEl = tabBtn.querySelector(".tab-close");
    closeEl.addEventListener("click", (e) => {
      e.stopPropagation();
      closeTab(id);
    });

    // Activate the new tab
    setActiveTab(id);
  }

  function setActiveTab(id) {
    activeTabId = id;
    tabs.forEach(tab => {
      const isActive = tab.id === id;
      tab.tabBtn.classList.toggle("active", isActive);
      tab.panel.classList.toggle("active", isActive);
    });
  }

  function getActiveTab() {
    return tabs.find(t => t.id === activeTabId) || null;
  }

  function closeTab(id) {
    const index = tabs.findIndex(t => t.id === id);
    if (index === -1) return;

    const tab = tabs[index];

    // Remove from DOM
    tab.tabBtn.remove();
    tab.panel.remove();

    // Remove from array
    tabs.splice(index, 1);

    if (!tabs.length) {
      // No tabs left: create a new clean one
      createTab();
      return;
    }

    // If the closed tab was active, pick neighbor
    if (activeTabId === id) {
      const newIndex = index > 0 ? index - 1 : 0;
      setActiveTab(tabs[newIndex].id);
    }
  }

  addTabBtn.addEventListener("click", createTab);

  compareBtn.addEventListener("click", () => {
    const tab = getActiveTab();
    if (!tab) return;
    const hasDiff = applyDiffToEditors(tab.leftEditor, tab.rightEditor);

    statusMessage.classList.remove("status-ok", "status-diff");
    if (hasDiff) {
      statusMessage.textContent = "Differences found between left and right text.";
      statusMessage.classList.add("status-diff");
    } else {
      statusMessage.textContent = "No differences found â€” texts are identical.";
      statusMessage.classList.add("status-ok");
    }
  });

  clearBtn.addEventListener("click", () => {
    const tab = getActiveTab();
    if (!tab) return;

    clearFormatting(tab.leftEditor);
    clearFormatting(tab.rightEditor);

    statusMessage.textContent = "Ready to compare.";
    statusMessage.classList.remove("status-ok", "status-diff");
  });


  createTab();
</script>
</body>
</html>
